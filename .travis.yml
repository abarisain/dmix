language: scala
scala:
  - 2.10.2

before_install:
  - wget "$(wget http://developer.android.com/sdk/index.html -O-|grep -o 'http://[^"]*-linux[.][^"]*')" -O- | tar zx
  - export ANDROID_HOME="${PWD}/android-sdk-linux"
  - export PATH="${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/platform-tools"
  - sudo apt-get update -qq
  - if [ `uname -m` = x86_64 ]; then sudo apt-get install -qq --force-yes libgd2-xpm ia32-libs ia32-libs-multiarch > /dev/null; fi
  - export TOOLS=$(android list sdk --no-ui > listing; for i in 'Android SDK Platform-tools' 'Android SDK Build-tools' 'SDK Platform Android' 'Android Support Library' 'System Image'; do grep "$i" listing |head -1; done|cut -f1 -d-|tr -d \ |paste -sd,)
  - echo Updating $TOOLS
  - echo yes |android -s update sdk --filter $TOOLS --no-ui --force
  - wget http://www.scala-lang.org/files/archive/scala-$TRAVIS_SCALA_VERSION.tgz -O - |tar zx
  - export SCALA_PATH="${PWD}/scala-$TRAVIS_SCALA_VERSION"
  - echo git clone --depth 1 https://github.com/imsizon/ant-android-scala.git
  - export AAS="${PWD}/ant-android-scala"
  - sed -i s/source.dir/scala.source.dir/g ${AAS}/build-scala.xml
  - openssl aes-128-cbc -d -salt -in .travis-debug.enc -out .travis-debug -k $key
  - export KEY_STORE="${PWD}/.travis-debug"
  - ant_mirror=http://mirrors.ukfast.co.uk/sites/ftp.apache.org//ant/binaries/; wget "$ant_mirror$(wget $ant_mirror -O - |sed -n 's/.*>\([^<]*\.bz2\)<.*/\1/p')" -O - |tar jx
  - export PATH="$(ls -drv1 ${PWD}/apache-ant-*|head -1)/bin:${PATH}"
  - export APP="$(sed 's/.*"app_name"[^>]*>\([^<]*\).*/\1/p' -n ./main/res/values-de/strings.xml)"

script:
  - cd ./main
  - envsubst < local.properties.tmpl |tee local.properties
  - cp ${SCALA_PATH}/lib/scala-library.jar libs/
  - ant clean
  - ant debug

env:
  global:
    secure: YAXKp+63QcUZdFNAXrFA7iAC8WEiKg6qXWFlIWkHZIs+Vajylv+IFsh9f4TSUK1LC8HwzOgA0KlZE0v32E9hA3LHu/mPvocvKE8psYO6yR/ozLcBDy+9dA6/M5WUqieHnjNazdmF4NWjrLkN91qkX/g7hy3erHWCBTWC+MDmSz4=

after_success:
  - cat ../.travis.hosts >> $HOME/.ssh/known_hosts
  - openssl aes-128-cbc -d -salt -in ../.travis-deploy.enc -out .travis-deploy -k $key
  - chmod 600 .travis-deploy
  - ssh-agent bash -c "ssh-add .travis-deploy; git clone --depth=1 --branch=downloads git@github.com:${TRAVIS_REPO_SLUG} downloads"
  - cd downloads
  - find ../bin -name '*.apk'|while read i; do cp $i ${APP}-${i#*-}; done
  - git add \*.apk
  - git config user.email "${USER}@$(hostname -f)"
  - git config user.name "Travis CI"
  - git commit -m "Travis build ${TRAVIS_BUILD_NUMBER} for ${TRAVIS_COMMIT} (${TRAVIS_BRANCH})"
  - ssh-agent bash -c "ssh-add ../.travis-deploy; git push origin downloads:downloads"
