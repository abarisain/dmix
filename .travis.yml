language: scala
scala:
  - 2.10.2

before_install:
  - wget http://dl.google.com/android/android-sdk_r22.0.5-linux.tgz -O - | tar zx
  - export ANDROID_HOME="${PWD}/android-sdk-linux"
  - export PATH="${PATH}:${ANDROID_HOME}/tools:${ANDROID_HOME}/platform-tools"
  - sudo apt-get update -qq
  - if [ `uname -m` = x86_64 ]; then sudo apt-get install -qq --force-yes libgd2-xpm ia32-libs ia32-libs-multiarch > /dev/null; fi
  - export TOOLS=$(android list sdk --no-ui | grep "Android SDK Platform-tools" | cut -d"-" -f1)
  - env
  - echo yes |android -s update sdk --filter $TOOLS,build-tools-18.0.1,android-18,extra-android-support,sysimg-18 --no-ui --force
  - wget http://www.scala-lang.org/files/archive/scala-$TRAVIS_SCALA_VERSION.tgz -O - |tar zx
  - export SCALA_PATH="${PWD}/scala-$TRAVIS_SCALA_VERSION"
  - echo git clone --depth 1 https://github.com/imsizon/ant-android-scala.git
  - export AAS="${PWD}/ant-android-scala"
  - sed -i s/source.dir/scala.source.dir/g ${AAS}/build-scala.xml
  - openssl aes-128-cbc -d -salt -in .travis-debug.enc -out .travis-debug -k $key
  - export KEY_STORE="${PWD}/.travis-debug"

script:
  - cd ./MPDroid
  - envsubst < local.properties.tmpl |tee local.properties
  - cp ${SCALA_PATH}/lib/scala-library.jar libs/
  - ant clean
  - ant debug

env:
  global:
    secure: YAXKp+63QcUZdFNAXrFA7iAC8WEiKg6qXWFlIWkHZIs+Vajylv+IFsh9f4TSUK1LC8HwzOgA0KlZE0v32E9hA3LHu/mPvocvKE8psYO6yR/ozLcBDy+9dA6/M5WUqieHnjNazdmF4NWjrLkN91qkX/g7hy3erHWCBTWC+MDmSz4=

after_success:
  - cat ../.travis.hosts >> $HOME/.ssh/known_hosts
  - openssl aes-128-cbc -d -salt -in ../.travis-deploy.enc -out .travis-deploy -k $key
  - chmod 600 .travis-deploy
  - ssh-agent bash -c "ssh-add .travis-deploy; git clone --depth=1 --branch=downloads git@github.com:${TRAVIS_REPO_SLUG} downloads"
  - cd downloads
  - find ../bin -name '*.apk'|while read i; do cp $i $(basename $(cd ..; pwd -P))-${i#*-}; done
  - git add \*.apk
  - git config user.email "${USER}@$(hostname -f)"
  - git config user.name "Travis CI"
  - git commit -m "Travis build ${TRAVIS_BUILD_NUMBER} for ${TRAVIS_COMMIT} (${TRAVIS_BRANCH})"
  - ssh-agent bash -c "ssh-add ../.travis-deploy; git push origin downloads:downloads"
